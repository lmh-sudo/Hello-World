<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Self-Intro (Auto-Model)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .container { max-width: 800px; margin-top: 30px; margin-bottom: 50px; }
        .card { border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: none; }
        .step-section { display: none; animation: fadeIn 0.5s; }
        .step-section.active { display: block; }
        .chat-container { height: 400px; overflow-y: auto; background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #dee2e6; margin-bottom: 15px; }
        .message { margin-bottom: 15px; padding: 12px 16px; border-radius: 15px; max-width: 85%; line-height: 1.5; }
        .message.user { background-color: #0d6efd; color: white; margin-left: auto; }
        .message.model { background-color: #e9ecef; color: #333; margin-right: auto; }
        .message p { margin-bottom: 0.5rem; }
        .loading { display: none; text-align: center; color: #666; font-style: italic; margin-top: 10px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="card p-4">
        <h2 class="text-center text-primary mb-3">ğŸ¤– AI Self-Introduction Helper</h2>

        <div class="alert alert-secondary p-2 mb-4 d-flex align-items-center">
            <small class="me-2 fw-bold">Current Model:</small>
            <select id="modelSelect" class="form-select form-select-sm" style="max-width: 300px;">
                <option value="" disabled selected>Loading available models...</option>
            </select>
            <button onclick="fetchModels()" class="btn btn-sm btn-outline-dark ms-2">â†» Refresh</button>
        </div>

        <div id="step1" class="step-section active">
            <h4 class="mb-3 text-primary border-bottom pb-2">Step 1: Who are you?</h4>
            <div class="mb-3">
                <label>Name:</label>
                <input type="text" id="inputName" class="form-control" placeholder="e.g. Chris Wong">
            </div>
            <div class="mb-3">
                <label>Grade:</label>
                <select id="inputGrade" class="form-select">
                    <option value="Form 1">Secondary 1 (Junior)</option>
                    <option value="Form 2">Secondary 2 (Junior)</option>
                    <option value="Form 3">Secondary 3 (Junior)</option>
                    <option value="Senior Form">Secondary 4-6 (Senior/DSE)</option>
                </select>
            </div>
            <button onclick="nextStep(2)" class="btn btn-primary w-100">Next â¡</button>
        </div>

        <div id="step2" class="step-section">
            <h4 class="mb-3 text-primary border-bottom pb-2">Step 2: Details</h4>
            <div class="mb-3">
                <label>Hobbies:</label>
                <input type="text" id="inputHobbies" class="form-control" placeholder="e.g. swimming">
            </div>
            <div class="mb-3">
                <label>Personality:</label>
                <input type="text" id="inputPersonality" class="form-control" placeholder="e.g. friendly">
            </div>
            <div class="mb-3">
                <label>Dream:</label>
                <input type="text" id="inputDream" class="form-control" placeholder="e.g. YouTuber">
            </div>
            <div class="d-flex justify-content-between mt-3">
                <button onclick="nextStep(1)" class="btn btn-secondary">â¬… Back</button>
                <button onclick="generateDraft()" class="btn btn-success">Generate AI Draft âœ¨</button>
            </div>
        </div>

        <div id="step3" class="step-section">
            <h4 class="mb-3 text-primary border-bottom pb-2">Step 3: Refine with AI</h4>
            <div id="chatBox" class="chat-container"></div>
            
            <div id="loadingMsg" class="loading">
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                AI is thinking...
            </div>

            <div class="input-group mt-3">
                <input type="text" id="userMessage" class="form-control" placeholder="Type instructions here...">
                <button onclick="sendUserMessage()" class="btn btn-primary" id="sendBtn">Send ğŸš€</button>
            </div>
            <button onclick="location.reload()" class="btn btn-outline-danger btn-sm mt-3">Start Over</button>
        </div>
    </div>
</div>

<script>
    // ========================================================
    // ã€è¨­å®šå€ã€‘è«‹å¡«å…¥æ‚¨çš„ Google API Key
    // ========================================================
    const API_KEY = "AIzaSyCgdOIyEOQxPE8AbjKtDypiiTydzWxnGjM"; 
    // ========================================================

    let chatHistory = []; 

    // åˆå§‹åŒ–ï¼šç¶²é è¼‰å…¥æ™‚è‡ªå‹•ç²å–æ¨¡å‹åˆ—è¡¨
    window.onload = function() {
        if (API_KEY === "YOUR_GEMINI_API_KEY_HERE" || API_KEY === "") {
            alert("è«‹åœ¨ä»£ç¢¼ä¸­å¡«å…¥ API Keyï¼");
        } else {
            fetchModels();
        }
    };

    // 1. è‡ªå‹•ç²å–å¯ç”¨æ¨¡å‹çš„åŠŸèƒ½ (è§£æ±º Model Not Found çš„æ ¸å¿ƒ)
    async function fetchModels() {
        const select = document.getElementById('modelSelect');
        select.innerHTML = '<option>Checking models...</option>';

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`);
            const data = await response.json();

            if (data.error) {
                alert("API Key Error: " + data.error.message);
                select.innerHTML = '<option>Error loading models</option>';
                return;
            }

            // éæ¿¾å‡ºå¯ä»¥ç”¨æ–¼ generateContent çš„æ¨¡å‹
            const availableModels = data.models.filter(model => 
                model.supportedGenerationMethods.includes("generateContent")
            );

            select.innerHTML = ''; // æ¸…ç©ºé¸é …
            
            // å„ªå…ˆå°‹æ‰¾ flash æ¨¡å‹
            let defaultSelected = false;

            availableModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name; // ä¾‹å¦‚ "models/gemini-1.5-flash"
                // ç°¡åŒ–é¡¯ç¤ºåç¨±
                option.text = model.displayName + ` (${model.name.replace('models/', '')})`;
                
                // è‡ªå‹•é¸æ“‡å«æœ‰ 'flash' çš„æœ€æ–°æ¨¡å‹
                if (!defaultSelected && model.name.includes('flash')) {
                    option.selected = true;
                    defaultSelected = true;
                }
                
                select.appendChild(option);
            });

            // å¦‚æœæ²’æ‰¾åˆ° flashï¼Œå°±é¸ç¬¬ä¸€å€‹
            if (!defaultSelected && select.options.length > 0) {
                select.options[0].selected = true;
            }

        } catch (e) {
            console.error(e);
            select.innerHTML = '<option>Connection Failed</option>';
        }
    }

    function nextStep(step) {
        document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active'));
        document.getElementById('step' + step).classList.add('active');
    }

    async function generateDraft() {
        const name = document.getElementById('inputName').value || "Student";
        const grade = document.getElementById('inputGrade').value;
        const hobbies = document.getElementById('inputHobbies').value || "none";
        const personality = document.getElementById('inputPersonality').value || "nice";
        const dream = document.getElementById('inputDream').value || "undecided";

        let levelInstruction = grade === "Senior Form" 
            ? "Use complex sentence structures, relative clauses." 
            : "Use simple grammar (Present Tense), short sentences.";

        const prompt = `
        Role: Hong Kong English Teacher.
        Task: Write a self-intro for ${name} (Grade: ${grade}).
        Details: Hobbies - ${hobbies}, Personality - ${personality}, Dream - ${dream}.
        Requirement: ${levelInstruction}
        Output: A natural paragraph (100-150 words).
        `;

        nextStep(3);
        addMessageToUI('user', `(System: Generating draft...)`);
        await callGemini(prompt);
    }

    async function sendUserMessage() {
        const input = document.getElementById('userMessage');
        const text = input.value.trim();
        if (!text) return;
        addMessageToUI('user', text);
        input.value = '';
        await callGemini(text);
    }

    // æ ¸å¿ƒ API å‘¼å« (ä½¿ç”¨ä¸‹æ‹‰é¸å–®é¸ä¸­çš„æ¨¡å‹)
    async function callGemini(userText) {
        const loading = document.getElementById('loadingMsg');
        const sendBtn = document.getElementById('sendBtn');
        const modelSelect = document.getElementById('modelSelect');
        
        // ç²å–ç•¶å‰é¸ä¸­çš„æ¨¡å‹åç¨± (ä¾‹å¦‚ models/gemini-1.5-flash-002)
        const selectedModel = modelSelect.value; 

        if (!selectedModel) {
            alert("No model selected or models failed to load.");
            return;
        }

        loading.style.display = 'block';
        sendBtn.disabled = true;

        chatHistory.push({ role: "user", parts: [{ text: userText }] });

        const requestBody = {
            contents: chatHistory,
            generationConfig: { temperature: 0.7, maxOutputTokens: 800 }
        };

        try {
            // å‹•æ…‹æ’å…¥é¸ä¸­çš„æ¨¡å‹åç¨±
            const url = `https://generativelanguage.googleapis.com/v1beta/${selectedModel}:generateContent?key=${API_KEY}`;
            
            const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();

            if (data.error) {
                console.error("API Error:", data.error);
                addMessageToUI('model', `âš ï¸ Error: ${data.error.message}`);
            } else {
                const aiText = data.candidates[0].content.parts[0].text;
                addMessageToUI('model', aiText);
                chatHistory.push({ role: "model", parts: [{ text: aiText }] });
            }

        } catch (error) {
            console.error(error);
            addMessageToUI('model', "âš ï¸ Connection Error.");
        } finally {
            loading.style.display = 'none';
            sendBtn.disabled = false;
        }
    }

    function addMessageToUI(role, text) {
        const chatBox = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.className = `message ${role}`;
        div.innerHTML = marked.parse(text);
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

</body>
</html>
