<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI English Self-Intro (Test Version)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 800px; margin-top: 30px; margin-bottom: 50px; }
        .card { border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: none; }
        .step-section { display: none; animation: fadeIn 0.5s; }
        .step-section.active { display: block; }
        
        /* èŠå¤©å®¤æ¨£å¼ */
        .chat-container { height: 400px; overflow-y: auto; background: #f9f9f9; padding: 20px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 15px; }
        .message { margin-bottom: 15px; padding: 10px 15px; border-radius: 15px; max-width: 85%; word-wrap: break-word; }
        .message.user { background-color: #007bff; color: white; margin-left: auto; border-bottom-right-radius: 2px; }
        .message.model { background-color: #e9ecef; color: #333; margin-right: auto; border-bottom-left-radius: 2px; }
        .message p { margin-bottom: 0; } /* ä¿®æ­£ Markdown çš„æ®µè½é–“è· */
        
        .loading { display: none; text-align: center; color: #666; font-style: italic; margin-top: 10px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="card p-4">
        <h2 class="text-center text-primary mb-4">ğŸ¤– AI Self-Introduction Helper</h2>

        <div id="step1" class="step-section active">
            <h4 class="mb-3 border-bottom pb-2">Step 1: Who are you?</h4>
            <div class="mb-3">
                <label>Name:</label>
                <input type="text" id="inputName" class="form-control" placeholder="e.g. Chris Wong">
            </div>
            <div class="mb-3">
                <label>Grade:</label>
                <select id="inputGrade" class="form-select">
                    <option value="Form 1">Secondary 1 (Junior)</option>
                    <option value="Form 2">Secondary 2 (Junior)</option>
                    <option value="Form 3">Secondary 3 (Junior)</option>
                    <option value="Senior Form">Secondary 4-6 (Senior/DSE)</option>
                </select>
            </div>
            <button onclick="nextStep(2)" class="btn btn-primary w-100">Next â¡</button>
        </div>

        <div id="step2" class="step-section">
            <h4 class="mb-3 border-bottom pb-2">Step 2: Details</h4>
            <div class="mb-3">
                <label>Hobbies:</label>
                <input type="text" id="inputHobbies" class="form-control" placeholder="e.g. playing online games, swimming">
            </div>
            <div class="mb-3">
                <label>Personality / Strengths:</label>
                <input type="text" id="inputPersonality" class="form-control" placeholder="e.g. friendly, active, helpful">
            </div>
            <div class="mb-3">
                <label>Dream / Future Goal:</label>
                <input type="text" id="inputDream" class="form-control" placeholder="e.g. want to be a YouTuber">
            </div>
            <div class="d-flex justify-content-between">
                <button onclick="nextStep(1)" class="btn btn-secondary">â¬… Back</button>
                <button onclick="generateDraft()" class="btn btn-success">Generate AI Draft âœ¨</button>
            </div>
        </div>

        <div id="step3" class="step-section">
            <h4 class="mb-3 border-bottom pb-2">Step 3: Refine with AI</h4>
            <div id="chatBox" class="chat-container"></div>
            
            <div id="loadingMsg" class="loading">
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                AI is thinking...
            </div>

            <div class="input-group mt-3">
                <input type="text" id="userMessage" class="form-control" placeholder="e.g. Make it simpler / Add that I have a cat">
                <button onclick="sendUserMessage()" class="btn btn-primary" id="sendBtn">Send</button>
            </div>
            <button onclick="location.reload()" class="btn btn-outline-danger btn-sm mt-3">Start Over</button>
        </div>
    </div>
</div>

<script>
    // ========================================================
    // ã€è¨­å®šå€ã€‘è«‹åœ¨é€™è£¡å¡«å…¥æ‚¨çš„ Google Gemini API Key
    // ========================================================
    const API_KEY = "AIzaSyCgdOIyEOQxPE8AbjKtDypiiTydzWxnGjM"; 
    // ========================================================

    let chatHistory = []; // å„²å­˜å°è©±ç´€éŒ„

    // åˆ‡æ›æ­¥é©Ÿé¡¯ç¤º
    function nextStep(step) {
        document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active'));
        document.getElementById('step' + step).classList.add('active');
    }

    // ç¬¬ä¸€æ¬¡ç”Ÿæˆæ–‡ç« 
    async function generateDraft() {
        const name = document.getElementById('inputName').value || "Student";
        const grade = document.getElementById('inputGrade').value;
        const hobbies = document.getElementById('inputHobbies').value || "none";
        const personality = document.getElementById('inputPersonality').value || "nice";
        const dream = document.getElementById('inputDream').value || "undecided";

        let levelInstruction = grade === "Senior Form" 
            ? "Use complex sentence structures, relative clauses, and DSE-level vocabulary." 
            : "Use simple grammar (Present Tense), short sentences, and easy vocabulary.";

        // æ§‹å»º System Prompt (ç¬¬ä¸€æ¢æŒ‡ä»¤)
        const prompt = `
        Role: You are a helpful Hong Kong secondary school English teacher.
        Task: Write a self-introduction for a student.
        
        Student Profile:
        - Name: ${name}
        - Grade: ${grade}
        - Hobbies: ${hobbies}
        - Personality: ${personality}
        - Dream: ${dream}
        
        Requirement: ${levelInstruction}
        Output: Write a natural paragraph (approx. 100-150 words).
        `;

        nextStep(3);
        addMessageToUI('user', `(System: Generating draft for ${name}...)`);
        await callGemini(prompt);
    }

    // ç™¼é€ä½¿ç”¨è€…å¾®èª¿æŒ‡ä»¤
    async function sendUserMessage() {
        const input = document.getElementById('userMessage');
        const text = input.value.trim();
        if (!text) return;

        addMessageToUI('user', text);
        input.value = '';
        await callGemini(text);
    }

    // æ ¸å¿ƒåŠŸèƒ½ï¼šå‘¼å« Gemini API (ä½¿ç”¨ fetch)
    async function callGemini(userText) {
        if (API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
            alert("è«‹å…ˆåœ¨ä»£ç¢¼ä¸­å¡«å…¥æ‚¨çš„ API Keyï¼");
            return;
        }

        const loading = document.getElementById('loadingMsg');
        const sendBtn = document.getElementById('sendBtn');
        loading.style.display = 'block';
        sendBtn.disabled = true;

        // 1. æ›´æ–°æ­·å²ç´€éŒ„
        chatHistory.push({
            role: "user",
            parts: [{ text: userText }]
        });

        // 2. æº–å‚™ API è«‹æ±‚è³‡æ–™
        const requestBody = {
            contents: chatHistory,
            generationConfig: {
                temperature: 0.7,
                maxOutputTokens: 800
            }
        };

        try {
            // 3. ç›´æ¥ç™¼é€è«‹æ±‚åˆ° Google (ä¸ç¶“é PHP)
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();

            if (data.error) {
                addMessageToUI('model', "âš ï¸ Error: " + data.error.message);
            } else {
                const aiText = data.candidates[0].content.parts[0].text;
                addMessageToUI('model', aiText);

                // å°‡ AI å›è¦†åŠ å…¥æ­·å²ç´€éŒ„
                chatHistory.push({
                    role: "model",
                    parts: [{ text: aiText }]
                });
            }

        } catch (error) {
            console.error(error);
            addMessageToUI('model', "âš ï¸ Connection Error. Please check your internet or API Key.");
        } finally {
            loading.style.display = 'none';
            sendBtn.disabled = false;
        }
    }

    // é¡¯ç¤ºè¨Šæ¯åœ¨èŠå¤©å®¤
    function addMessageToUI(role, text) {
        const chatBox = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.className = `message ${role}`;
        
        // ä½¿ç”¨ Marked.js å°‡ Markdown è½‰ç‚º HTML (ä¾‹å¦‚ **ç²—é«”** è®Š <b>)
        div.innerHTML = marked.parse(text);
        
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

</body>
</html>