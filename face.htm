<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI äººè‡‰è­˜åˆ¥ - å¤šäººå­¸ç¿’ç‰ˆ</title>
    <script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background-color: #f0f2f5; padding: 20px; }
        
        /* ç‰ˆé¢é…ç½®ï¼šå·¦é‚Šæ˜¯å½±ç‰‡ï¼Œå³é‚Šæ˜¯å­¸ç¿’åˆ—è¡¨ */
        .container { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        
        .video-section { position: relative; }
        video { border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); background-color: #000; }
        canvas { position: absolute; top: 0; left: 0; }

        .controls-section { 
            text-align: left; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            min-width: 300px;
            max-width: 400px;
        }

        input { padding: 10px; font-size: 16px; width: 60%; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;}
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 5px; width: 30%; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        #status { display: block; margin: 10px 0; font-weight: bold; color: #555; }
        
        /* å­¸ç¿’åå–®çš„æ¨£å¼ */
        h3 { margin-top: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        ul { list-style-type: none; padding: 0; max-height: 400px; overflow-y: auto; }
        li { background: #e8f5e9; margin: 5px 0; padding: 10px; border-radius: 5px; border-left: 5px solid #4CAF50; animation: fadeIn 0.5s; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <h1>ğŸ¤– AI äººè‡‰è³‡æ–™åº«æ§‹å»ºé«”é©—</h1>

    <div class="container">
        <div class="video-section">
            <video id="video" width="720" height="560" autoplay muted></video>
            <canvas id="canvas" width="720" height="560"></canvas>
        </div>

        <div class="controls-section">
            <div id="input-group">
                <input type="text" id="nameInput" placeholder="è¼¸å…¥åå­— (ä¾‹å¦‚: é™³å¤§æ–‡)">
                <button id="registerBtn" disabled>å­¸ç¿’</button>
            </div>
            <span id="status">â³ æ­£åœ¨è¼‰å…¥ AI æ¨¡å‹...</span>

            <h3>ğŸ“š å·²å­¸ç¿’çš„äººè‡‰åå–®</h3>
            <ul id="faceList">
                <li style="background: #f1f1f1; border-left: 5px solid #ccc; color: #666;">
                    â„¹ï¸ ç›®å‰è³‡æ–™åº«æ˜¯ç©ºçš„
                </li>
            </ul>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const nameInput = document.getElementById('nameInput');
        const registerBtn = document.getElementById('registerBtn');
        const status = document.getElementById('status');
        const faceList = document.getElementById('faceList');

        let labeledFaceDescriptors = []; 
        let faceMatcher = null;          

        // 1. è¼‰å…¥æ¨¡å‹ (ç¢ºä¿è·¯å¾‘æ­£ç¢º)
        Promise.all([
            faceapi.nets.ssdMobilenetv1.loadFromUri('./models'),     
            faceapi.nets.faceLandmark68Net.loadFromUri('./models'),  
            faceapi.nets.faceRecognitionNet.loadFromUri('./models')  
        ]).then(startVideo).catch(err => {
            status.innerText = "âŒ æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Console";
            console.error(err);
        });

        // 2. å•Ÿå‹•è¦–è¨Š
        function startVideo() {
            navigator.mediaDevices.getUserMedia({ video: {} })
                .then(stream => {
                    video.srcObject = stream;
                    status.innerText = 'ğŸ¥ è«‹è¼¸å…¥åå­—ä¸¦é»æ“Šã€Œå­¸ç¿’ã€';
                })
                .catch(err => console.error("é¡é ­éŒ¯èª¤:", err));
        }

        // 3. è™•ç†ã€Œå­¸ç¿’ã€æŒ‰éˆ•é»æ“Š
        registerBtn.addEventListener('click', async () => {
            const name = nameInput.value.trim();
            if (!name) return alert('è«‹å…ˆè¼¸å…¥åå­—ï¼');
            
            status.innerText = 'ğŸ”„ æ­£åœ¨åˆ†æè‡‰éƒ¨ç‰¹å¾µ...';
            registerBtn.disabled = true;

            // åµæ¸¬å–®å¼µäººè‡‰
            const detection = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();

            if (detection) {
                // A. å°‡æ•¸æ“šåŠ å…¥è¨˜æ†¶é«”
                const descriptor = [detection.descriptor];
                labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(name, descriptor));
                
                // B. æ›´æ–°æ¯”å°å™¨
                faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.6);
                
                // C. æ›´æ–°ä»‹é¢ï¼šæ–°å¢ä¸€è¡Œåˆ°åˆ—è¡¨ä¸­
                addFaceToList(name);

                status.innerText = `âœ… ç³»çµ±å·²å°±ç·’ï¼Œå¯è­˜åˆ¥ï¼š${name}`;
                nameInput.value = ''; 
            } else {
                status.innerText = 'âš ï¸ æ‰¾ä¸åˆ°äººè‡‰ï¼Œè«‹é è¿‘ä¸€é»æˆ–èª¿æ•´å…‰ç·šã€‚';
            }
            registerBtn.disabled = false;
        });

        // è¼”åŠ©å‡½å¼ï¼šæ–°å¢åˆ—è¡¨é …ç›® (DOM æ“ä½œ)
        function addFaceToList(name) {
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å­¸ç¿’ï¼Œå…ˆæŠŠã€Œç›®å‰è³‡æ–™åº«æ˜¯ç©ºçš„ã€é‚£è¡Œåˆªæ‰
            if (labeledFaceDescriptors.length === 1) {
                faceList.innerHTML = '';
            }

            const li = document.createElement('li');
            const time = new Date().toLocaleTimeString(); // åŠ ä¸Šæ™‚é–“æˆ³è¨˜
            li.innerHTML = `<strong>${name}</strong> <span style="font-size:0.8em; color:#666;">(${time})</span>`;
            
            // å°‡æœ€æ–°çš„åŠ åˆ°æœ€ä¸Šé¢ (prepend)ï¼Œå¦‚æœè¦åŠ åˆ°æœ€ä¸‹é¢ç”¨ appendChild
            faceList.prepend(li);
        }

        // 4. å½±ç‰‡æ’­æ”¾æ™‚å•Ÿå‹•å¾ªç’°åµæ¸¬
        video.addEventListener('play', () => {
            const displaySize = { width: video.width, height: video.height };
            faceapi.matchDimensions(canvas, displaySize);
            
            registerBtn.disabled = false; // å½±ç‰‡é–‹å§‹å¾Œæ‰å…è¨±æŒ‰éˆ•

            setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

                if (faceMatcher) {
                    const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));
                    
                    results.forEach((result, i) => {
                        const box = resizedDetections[i].detection.box;
                        const { label, distance } = result;
                        
                        // æ ¹æ“šæ˜¯å¦èªè­˜è®Šæ›´é¡è‰² (unknown ç‚ºç´…è‰²ï¼Œèªè­˜ç‚ºç¶ è‰²)
                        const color = label === 'unknown' ? 'red' : '#00ff00';
                        
                        const drawBox = new faceapi.draw.DrawBox(box, { label: label + ` (${Math.round(distance*100)/100})`, boxColor: color });
                        drawBox.draw(canvas);
                    });
                } else {
                    faceapi.draw.drawDetections(canvas, resizedDetections);
                }
            }, 100);
        });
    </script>
</body>
</html>
