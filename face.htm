<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI äººè‡‰è­˜åˆ¥é«”é©—</title>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background-color: #f4f4f9; padding: 20px; }
        .controls { margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: inline-block;}
        input { padding: 8px; font-size: 16px; margin-right: 10px; }
        button { padding: 8px 16px; font-size: 16px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 4px; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status { display: block; margin-top: 10px; font-weight: bold; color: #333; }
        /* è®“ Canvas ç–ŠåŠ åœ¨ Video ä¸Šé¢ï¼Œç”¨ä¾†ç•«æ¡†æ¡† */
        #video-container { position: relative; display: inline-block; }
        #video { border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        #canvas { position: absolute; top: 0; left: 0; }
    </style>
</head>
<body>

    <h1>ğŸ¤– äººè‡‰è­˜åˆ¥èˆ‡å­¸ç¿’ç³»çµ±</h1>
    
    <div class="controls">
        <input type="text" id="nameInput" placeholder="è«‹è¼¸å…¥ä½ çš„åå­—">
        <button id="registerBtn" disabled>ğŸ“¸ å­¸ç¿’é€™å¼µè‡‰</button>
        <span id="status">â³ æ­£åœ¨è¼‰å…¥ AI æ¨¡å‹ï¼Œè«‹ç¨å€™...</span>
    </div>

    <div id="video-container">
        <video id="video" width="720" height="560" autoplay muted></video>
        <canvas id="canvas" width="720" height="560"></canvas>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const nameInput = document.getElementById('nameInput');
        const registerBtn = document.getElementById('registerBtn');
        const status = document.getElementById('status');

        let labeledFaceDescriptors = []; // å„²å­˜å·²å­¸ç¿’çš„äººè‡‰ç‰¹å¾µè³‡æ–™
        let faceMatcher = null;          // äººè‡‰æ¯”å°å™¨

        // 1. è¼‰å…¥ AI æ¨¡å‹ (è«‹ç¢ºä¿ models è³‡æ–™å¤¾å­˜åœ¨ä¸¦åŒ…å«æ¬Šé‡æª”)
        Promise.all([
            faceapi.nets.ssdMobilenetv1.loadFromUri('./models'),     // äººè‡‰æª¢æ¸¬æ¨¡å‹
            faceapi.nets.faceLandmark68Net.loadFromUri('./models'),  // è‡‰éƒ¨ç‰¹å¾µé»æ¨¡å‹ (çœ¼ç›ã€é¼»å­ç­‰ 68 å€‹é»)
            faceapi.nets.faceRecognitionNet.loadFromUri('./models')  // äººè‡‰ç‰¹å¾µå‘é‡ (128ç¶­) è½‰æ›æ¨¡å‹
        ]).then(startVideo).catch(err => console.error("æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼š", err));

        // 2. é–‹å•Ÿ WebCam
        function startVideo() {
            status.innerText = 'âœ… æ¨¡å‹è¼‰å…¥å®Œæˆï¼æ­£åœ¨é–‹å•Ÿé¡é ­...';
            navigator.mediaDevices.getUserMedia({ video: {} })
                .then(stream => {
                    video.srcObject = stream;
                    registerBtn.disabled = false;
                    status.innerText = 'ğŸ¥ ç³»çµ±å°±ç·’ï¼è«‹è¼¸å…¥åå­—ä¸¦é»æ“Šã€Œå­¸ç¿’é€™å¼µè‡‰ã€';
                })
                .catch(err => {
                    status.innerText = 'âŒ ç„¡æ³•å­˜å–é¡é ­ï¼Œè«‹æª¢æŸ¥æ¬Šé™ã€‚';
                    console.error(err);
                });
        }

        // 3. å­¸ç¿’äººè‡‰ (è¨»å†Š)
        registerBtn.addEventListener('click', async () => {
            const name = nameInput.value.trim();
            if (!name) return alert('è«‹å…ˆè¼¸å…¥åå­—ï¼');
            
            status.innerText = 'ğŸ”„ æ­£åœ¨æ“·å–è‡‰éƒ¨ç‰¹å¾µï¼Œè«‹çœ‹è‘—é¡é ­...';
            registerBtn.disabled = true;

            // æ“·å–å–®å¼µäººè‡‰ä¸¦è¨ˆç®—ç‰¹å¾µ (Descriptor)
            const detection = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();

            if (detection) {
                // å°‡ç‰¹å¾µèˆ‡åå­—ç¶å®šï¼ŒåŠ å…¥è³‡æ–™åº« (è¨˜æ†¶é«”ä¸­)
                const descriptor = [detection.descriptor];
                labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(name, descriptor));
                
                // å»ºç«‹æˆ–æ›´æ–°æ¯”å°å™¨ (å®¹éŒ¯ç‡è¨­ç‚º 0.6ï¼Œè¶Šä½è¶Šåš´æ ¼)
                faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.6);
                
                status.innerText = `ğŸ‰ æˆåŠŸå­¸ç¿’ï¼š${name}ï¼`;
                nameInput.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
            } else {
                status.innerText = 'âš ï¸ æ‰¾ä¸åˆ°äººè‡‰ï¼è«‹ç¢ºä¿å…‰ç·šå……è¶³ä¸¦æ­£å°é¡é ­ã€‚';
            }
            registerBtn.disabled = false;
        });

        // 4. å³æ™‚åµæ¸¬èˆ‡æ¯”å°è¿´åœˆ
        video.addEventListener('play', () => {
            // è¨­å®šç•«å¸ƒå¤§å°èˆ‡å½±ç‰‡ä¸€è‡´
            const displaySize = { width: video.width, height: video.height };
            faceapi.matchDimensions(canvas, displaySize);

            // æ¯ 100 æ¯«ç§’åŸ·è¡Œä¸€æ¬¡æª¢æ¸¬
            setInterval(async () => {
                // åµæ¸¬ç•«é¢ä¸­æ‰€æœ‰äººè‡‰çš„ç‰¹å¾µ
                const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                const resizedDetections = faceapi.resizeResults(detections, displaySize);

                // æ¸…ç©ºä¸Šä¸€å¹€çš„ç•«å¸ƒ
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

                if (faceMatcher) {
                    // å¦‚æœç³»çµ±å·²ç¶“å­¸éäººè‡‰ï¼Œé€²è¡Œæ¯”å°
                    const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));
                    
                    // å°‡çµæœç•«åœ¨ç•«å¸ƒä¸Š
                    results.forEach((result, i) => {
                        const box = resizedDetections[i].detection.box;
                        // å¦‚æœæ˜¯ known faceï¼Œé¡¯ç¤ºåå­—ï¼›å¦å‰‡æœƒé¡¯ç¤º unknown
                        const drawBox = new faceapi.draw.DrawBox(box, { label: result.toString() });
                        drawBox.draw(canvas);
                    });
                } else {
                    // å¦‚æœç³»çµ±é‚„æ²’å­¸éä»»ä½•äººï¼Œåªç•«å‡ºäººè‡‰çš„æ¡†æ¡†
                    faceapi.draw.drawDetections(canvas, resizedDetections);
                }
            }, 100);
        });
    </script>
</body>
</html>