<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½æ·±è¹²æ•™ç·´</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #2c3e50;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            color: white;
        }

        h1 { margin-bottom: 15px; }

        .container {
            position: relative;
            width: 640px;
            height: 480px;
            background-color: #000;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        #input_video { display: none; }
        #output_canvas { width: 100%; height: 100%; }

        /* è¨ˆåˆ†æ¿ */
        .scoreboard {
            position: absolute;
            top: 0; left: 0;
            background-color: rgba(245, 117, 16, 0.9);
            padding: 10px 20px;
            border-bottom-right-radius: 15px;
            display: flex;
            gap: 20px;
            z-index: 10;
        }

        .score-item { display: flex; flex-direction: column; }
        .label { font-size: 12px; font-weight: bold; opacity: 0.9; }
        .value { font-size: 28px; font-weight: bold; }

        /* === æ–°å¢ï¼šæ§åˆ¶é¢æ¿ (ä¸‹æ–¹æ»‘æ¡¿) === */
        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* åŠé€æ˜é»‘åº• */
            padding: 10px 20px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            z-index: 10;
        }

        .control-label { font-size: 16px; font-weight: bold; }
        
        /* æ»‘æ¡¿æ¨£å¼ */
        input[type=range] {
            width: 200px;
            cursor: pointer;
        }
        
        /* é¡¯ç¤ºç›®å‰è¨­å®šçš„è§’åº¦ */
        #angle-val {
            color: #f1c40f; /* é‡‘é»ƒè‰² */
            font-size: 20px;
            font-weight: bold;
            min-width: 50px;
        }

        #loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
        }
    </style>
</head>
<body>

    <h1>ğŸ‹ï¸â€â™‚ï¸ AI æ·±è¹²æ•™ç·´</h1>

    <div class="container">
        <div id="loading">è¼‰å…¥æ¨¡å‹ä¸­...</div>
        
        <div class="scoreboard">
            <div class="score-item">
                <span class="label">æ¬¡æ•¸ (REPS)</span>
                <span id="reps-display" class="value">0</span>
            </div>
            <div class="score-item">
                <span class="label">ç‹€æ…‹ (STAGE)</span>
                <span id="stage-display" class="value">-</span>
            </div>
        </div>

        <div class="controls">
            <span class="control-label">è¨­å®šé›£åº¦ (ç›®æ¨™è§’åº¦):</span>
            <input type="range" id="angle-slider" min="90" max="150" value="90" step="5">
            <span id="angle-val">90Â°</span>
        </div>

        <video id="input_video"></video>
        <canvas id="output_canvas" width="640" height="480"></canvas>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const repsDisplay = document.getElementById('reps-display');
        const stageDisplay = document.getElementById('stage-display');
        const loadingMsg = document.getElementById('loading');
        
        // æ–°å¢ï¼šç²å–æ»‘æ¡¿å…ƒç´ 
        const angleSlider = document.getElementById('angle-slider');
        const angleValDisplay = document.getElementById('angle-val');

        let count = 0;
        let stage = null;
        
        // é è¨­ç›®æ¨™è§’åº¦
        let targetAngle = 90;

        // === ç›£è½æ»‘æ¡¿è®ŠåŒ– ===
        angleSlider.addEventListener('input', function() {
            targetAngle = this.value; // æ›´æ–°ç›®æ¨™è®Šæ•¸
            angleValDisplay.innerText = this.value + "Â°"; // æ›´æ–°ç•«é¢ä¸Šé¡¯ç¤ºçš„æ•¸å­—
        });

        function calculateAngle(a, b, c) {
            const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180.0) angle = 360 - angle;
            return angle;
        }

        function onResults(results) {
            loadingMsg.style.display = 'none';
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                const landmarks = results.poseLandmarks;
                const hip = landmarks[23];
                const knee = landmarks[25];
                const ankle = landmarks[27];
                
                if (hip.visibility > 0.5 && knee.visibility > 0.5 && ankle.visibility > 0.5) {
                    const angle = calculateAngle(hip, knee, ankle);

                    // ç¹ªè£½å³æ™‚è§’åº¦
                    canvasCtx.fillStyle = 'white';
                    canvasCtx.font = '24px Arial';
                    canvasCtx.fillText(Math.round(angle), knee.x * canvasElement.width, knee.y * canvasElement.height);

                    // === æ·±è¹²é‚è¼¯ (ä½¿ç”¨ targetAngle è®Šæ•¸) ===
                    if (angle > 160) {
                        stage = "UP";
                    }
                    // é€™è£¡æ”¹æˆäº† targetAngle (åŸæœ¬æ˜¯ 90)
                    if (angle < targetAngle && stage === 'UP') {
                        stage = "DOWN";
                        count++;
                        repsDisplay.innerText = count;
                    }
                    stageDisplay.innerText = stage || "Stand";

                    // === è®Šè‰²é‚è¼¯ (åŒæ¨£é€£å‹• targetAngle) ===
                    let lineColor = '#00FF00';
                    let lineWidth = 4;
                    
                    if (angle < targetAngle) {
                        lineColor = '#00FF00'; // é”æ¨™è®Šç¶ 
                        lineWidth = 8;
                    } else {
                        lineColor = '#FF0000'; // æœªé”æ¨™ç´…è‰²
                    }

                    drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS,
                                 {color: lineColor, lineWidth: lineWidth});
                    drawLandmarks(canvasCtx, results.poseLandmarks,
                                {color: lineColor, lineWidth: 2, radius: 4});
                }
            }
            canvasCtx.restore();
        }

        const pose = new Pose({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
        }});

        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        pose.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await pose.send({image: videoElement});
            },
            width: 640,
            height: 480
        });
        camera.start();
    </script>
</body>
</html>

