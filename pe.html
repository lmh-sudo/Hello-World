<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å°ˆæ¥­æ·±è¹²æ•™ç·´</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #2c3e50;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            color: white;
        }

        h1 { margin-bottom: 10px; text-align: center; font-size: 24px;}

        .container {
            position: relative;
            width: 640px;
            height: 480px;
            background-color: #000;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        #input_video { display: none; }
        #output_canvas { width: 100%; height: 100%; }

        /* è¨ˆåˆ†æ¿ */
        .scoreboard {
            position: absolute;
            top: 0; left: 0;
            background-color: rgba(245, 117, 16, 0.9);
            padding: 10px 20px;
            border-bottom-right-radius: 15px;
            display: flex;
            gap: 20px;
            z-index: 10;
        }

        .score-item { display: flex; flex-direction: column; }
        .label { font-size: 12px; font-weight: bold; opacity: 0.9; }
        .value { font-size: 28px; font-weight: bold; }

        /* è­¦å‘Šè¨Šæ¯ */
        #warning-msg {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 30px;
            border-radius: 15px;
            font-size: 28px;
            font-weight: bold;
            display: none;
            z-index: 20;
            text-align: center;
            line-height: 1.5;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* æ§åˆ¶é¢æ¿ */
        .controls {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            z-index: 10;
        }
        
        input[type=range] { width: 200px; cursor: pointer; }
        #angle-val { color: #f1c40f; font-size: 20px; font-weight: bold; min-width: 50px; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; }

        /* === æ–°å¢ï¼š+1 ç‰¹æ•ˆçš„æ¨£å¼ === */
        #plus-one-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            /* åˆå§‹ç‹€æ…‹ï¼šç½®ä¸­ï¼Œä½†é€æ˜åº¦ç‚º 0 (éš±è—) */
            transform: translate(-50%, -50%) scale(0.5);
            font-size: 150px; /* å­—é«”è¶…å¤§ */
            font-weight: 900;
            color: #f1c40f; /* é‡‘é»ƒè‰² */
            text-shadow: 3px 3px 6px rgba(0,0,0,0.7); /* æ–‡å­—é™°å½±å¢åŠ ç«‹é«”æ„Ÿ */
            opacity: 0; 
            pointer-events: none; /* è®“æ»‘é¼ é»æ“Šç©¿é€å®ƒï¼Œä¸å½±éŸ¿æ“ä½œ */
            z-index: 30; /* åœ¨æœ€ä¸Šå±¤ */
        }

        /* å®šç¾©å‹•ç•«é—œéµå½±æ ¼ï¼šå½ˆå‡ºä¸¦å‘ä¸Šæ·¡å‡º */
        @keyframes popUpAndFadeOut {
            0% {
                opacity: 0;
                transform: translate(-50%, -40%) scale(0.5); /* å¾ç¨å¾®ä¸‹æ–¹é–‹å§‹ï¼Œæ¯”è¼ƒå° */
            }
            20% {
                opacity: 1; /* ç¬é–“é¡¯ç¤º */
                transform: translate(-50%, -50%) scale(1.2); /* å½ˆåˆ°ä¸­é–“ä¸¦æ”¾å¤§ */
            }
            100% {
                opacity: 0; /* æœ€å¾Œæ·¡å‡º */
                transform: translate(-50%, -80%) scale(1); /* å‘ä¸Šé£„ç§» */
            }
        }

        /* ç”¨ä¾†è§¸ç™¼å‹•ç•«çš„ class */
        .trigger-animation {
            /* åŸ·è¡Œå‹•ç•«ï¼šåç¨± æ™‚é–“ æ›²ç·š åƒ…åŸ·è¡Œä¸€æ¬¡ */
            animation: popUpAndFadeOut 0.8s ease-out forwards;
        }

    </style>
</head>
<body>

    <h1>ğŸ‹ï¸â€â™‚ï¸ AI å°ˆæ¥­æ·±è¹²æ•™ç·´</h1>

    <div class="container">
        <div id="loading">è¼‰å…¥æ¨¡å‹ä¸­...</div>
        
        <div id="plus-one-effect">+1</div>

        <div id="warning-msg">âš ï¸ è«‹å¹³èˆ‰é›™æ‰‹ï¼<br>(Raise Hands)</span></div>

        <div class="scoreboard">
            <div class="score-item">
                <span class="label">æ¬¡æ•¸ (REPS)</span>
                <span id="reps-display" class="value">0</span>
            </div>
            <div class="score-item">
                <span class="label">ç‹€æ…‹ (STAGE)</span>
                <span id="stage-display" class="value">-</span>
            </div>
        </div>

        <div class="controls">
            <span style="font-size:16px; font-weight:bold;">è…¿éƒ¨é›£åº¦:</span>
            <input type="range" id="angle-slider" min="80" max="150" value="90" step="5">
            <span id="angle-val">90Â°</span>
        </div>

        <video id="input_video"></video>
        <canvas id="output_canvas" width="640" height="480"></canvas>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const repsDisplay = document.getElementById('reps-display');
        const stageDisplay = document.getElementById('stage-display');
        const loadingMsg = document.getElementById('loading');
        const warningMsg = document.getElementById('warning-msg');
        const angleSlider = document.getElementById('angle-slider');
        const angleValDisplay = document.getElementById('angle-val');
        
        // æ–°å¢ï¼šç²å–ç‰¹æ•ˆå…ƒç´ 
        const plusOneElem = document.getElementById('plus-one-effect');

        let count = 0;
        let stage = null;
        let targetAngle = 90;

        // ç›£è½å‹•ç•«çµæŸäº‹ä»¶ï¼šç•¶å‹•ç•«æ’­å®Œå¾Œï¼Œç«‹åˆ»ç§»é™¤ trigger classï¼Œä»¥ä¾¿ä¸‹æ¬¡å¯ä»¥å†è§¸ç™¼
        plusOneElem.addEventListener('animationend', () => {
            plusOneElem.classList.remove('trigger-animation');
        });

        angleSlider.addEventListener('input', function() {
            targetAngle = this.value;
            angleValDisplay.innerText = this.value + "Â°";
        });

        function calculateAngle(a, b, c) {
            const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180.0) angle = 360 - angle;
            return angle;
        }

        function onResults(results) {
            loadingMsg.style.display = 'none';
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                const landmarks = results.poseLandmarks;
                const leftHip = landmarks[23]; const leftKnee = landmarks[25]; const leftAnkle = landmarks[27];
                const rightHip = landmarks[24]; const rightKnee = landmarks[26]; const rightAnkle = landmarks[28];
                const leftShoulder = landmarks[11]; const leftElbow = landmarks[13];
                const rightShoulder = landmarks[12]; const rightElbow = landmarks[14];

                const visibilityThreshold = 0.5;
                const isLegsVisible = leftHip.visibility > visibilityThreshold && leftKnee.visibility > visibilityThreshold && leftAnkle.visibility > visibilityThreshold &&
                                      rightHip.visibility > visibilityThreshold && rightKnee.visibility > visibilityThreshold && rightAnkle.visibility > visibilityThreshold;
                
                if (isLegsVisible) {
                    const angleLeftLeg = calculateAngle(leftHip, leftKnee, leftAnkle);
                    const angleRightLeg = calculateAngle(rightHip, rightKnee, rightAnkle);
                    const angleLeftArm = calculateAngle(leftElbow, leftShoulder, leftHip);
                    const angleRightArm = calculateAngle(rightElbow, rightShoulder, rightHip);

                    canvasCtx.fillStyle = 'white';
                    canvasCtx.font = '24px Arial';
                    canvasCtx.fillText(Math.round(angleLeftLeg), leftKnee.x * canvasElement.width + 10, leftKnee.y * canvasElement.height);
                    canvasCtx.fillText(Math.round(angleRightLeg), rightKnee.x * canvasElement.width - 40, rightKnee.y * canvasElement.height);

                    const armThreshold = 40; 
                    const isHandsUp = (angleLeftArm > armThreshold) && (angleRightArm > armThreshold);

                    if (!isHandsUp) {
                        warningMsg.style.display = "block"; 
                        drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#999999', lineWidth: 2});
                    } else {
                        warningMsg.style.display = "none";

                        // 1. è¹²ä¸‹éšæ®µ
                        if (angleLeftLeg < targetAngle && angleRightLeg < targetAngle) {
                            if (stage === 'UP') {
                                stage = "DOWN";
                            }
                        }

                        // 2. ç«™èµ·éšæ®µ (è¨ˆåˆ†æ™‚åˆ»)
                        if (angleLeftLeg > 160 && angleRightLeg > 160) {
                            if (stage === 'DOWN') {
                                count++;
                                repsDisplay.innerText = count;
                                stage = "UP"; 

                                // === åœ¨é€™è£¡è§¸ç™¼ +1 ç‰¹æ•ˆ ===
                                // åŠ ä¸Šé€™å€‹ class å°±æœƒé–‹å§‹æ’­æ”¾ CSS å‹•ç•«
                                plusOneElem.classList.add('trigger-animation');
                            } else if (stage === null) {
                                stage = "UP";
                            }
                        }

                        stageDisplay.innerText = stage || "Stand";

                        let lineColor = '#FF0000'; 
                        let lineWidth = 4;
                        if (angleLeftLeg < targetAngle && angleRightLeg < targetAngle) {
                            lineColor = '#00FF00'; 
                            lineWidth = 8;
                        }
                        drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: lineColor, lineWidth: lineWidth});
                        drawLandmarks(canvasCtx, results.poseLandmarks, {color: lineColor, lineWidth: 2, radius: 4});
                    }
                }
            }
            canvasCtx.restore();
        }

        const pose = new Pose({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
        }});
        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        pose.onResults(onResults);
        const camera = new Camera(videoElement, {
            onFrame: async () => { await pose.send({image: videoElement}); },
            width: 640,
            height: 480
        });
        camera.start();
    </script>
</body>
</html>

