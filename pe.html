<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI åš´æ ¼ç‰ˆæ·±è¹²æ•™ç·´</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #2c3e50;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            color: white;
        }

        h1 { margin-bottom: 15px; text-align: center;}

        .container {
            position: relative;
            width: 640px;
            height: 480px;
            background-color: #000;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        #input_video { display: none; }
        #output_canvas { width: 100%; height: 100%; }

        /* è¨ˆåˆ†æ¿ */
        .scoreboard {
            position: absolute;
            top: 0; left: 0;
            background-color: rgba(245, 117, 16, 0.9);
            padding: 10px 20px;
            border-bottom-right-radius: 15px;
            display: flex;
            gap: 20px;
            z-index: 10;
        }

        .score-item { display: flex; flex-direction: column; }
        .label { font-size: 12px; font-weight: bold; opacity: 0.9; }
        .value { font-size: 28px; font-weight: bold; }

        /* è­¦å‘Šè¨Šæ¯ (ç”¨ä¾†æç¤ºæ‰‹æ²’èˆ‰èµ·ä¾†) */
        #warning-msg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-size: 32px;
            font-weight: bold;
            display: none; /* é è¨­éš±è— */
            z-index: 20;
            text-align: center;
        }

        /* æ§åˆ¶é¢æ¿ */
        .controls {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            z-index: 10;
        }
        
        input[type=range] { width: 200px; cursor: pointer; }
        #angle-val { color: #f1c40f; font-size: 20px; font-weight: bold; min-width: 50px; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; }
    </style>
</head>
<body>

    <h1>ğŸ‹ï¸â€â™‚ï¸ é›™è…¿ + å¹³èˆ‰ åš´æ ¼åµæ¸¬</h1>

    <div class="container">
        <div id="loading">è¼‰å…¥æ¨¡å‹ä¸­...</div>
        
        <div id="warning-msg">è«‹å¹³èˆ‰é›™æ‰‹ï¼<br>(Raise Hands)</div>

        <div class="scoreboard">
            <div class="score-item">
                <span class="label">æ¬¡æ•¸ (REPS)</span>
                <span id="reps-display" class="value">0</span>
            </div>
            <div class="score-item">
                <span class="label">ç‹€æ…‹ (STAGE)</span>
                <span id="stage-display" class="value">-</span>
            </div>
        </div>

        <div class="controls">
            <span style="font-size:16px; font-weight:bold;">è…¿éƒ¨ç›®æ¨™è§’åº¦:</span>
            <input type="range" id="angle-slider" min="80" max="150" value="90" step="5">
            <span id="angle-val">90Â°</span>
        </div>

        <video id="input_video"></video>
        <canvas id="output_canvas" width="640" height="480"></canvas>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const repsDisplay = document.getElementById('reps-display');
        const stageDisplay = document.getElementById('stage-display');
        const loadingMsg = document.getElementById('loading');
        const warningMsg = document.getElementById('warning-msg');
        
        const angleSlider = document.getElementById('angle-slider');
        const angleValDisplay = document.getElementById('angle-val');

        let count = 0;
        let stage = null;
        let targetAngle = 90;

        angleSlider.addEventListener('input', function() {
            targetAngle = this.value;
            angleValDisplay.innerText = this.value + "Â°";
        });

        // è¨ˆç®—ä¸‰é»è§’åº¦
        function calculateAngle(a, b, c) {
            const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180.0) angle = 360 - angle;
            return angle;
        }

        function onResults(results) {
            loadingMsg.style.display = 'none';
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                const landmarks = results.poseLandmarks;

                // === 1. ç²å–é—œéµé» (å·¦è…¿ + å³è…¿) ===
                const leftHip = landmarks[23];
                const leftKnee = landmarks[25];
                const leftAnkle = landmarks[27];

                const rightHip = landmarks[24];
                const rightKnee = landmarks[26];
                const rightAnkle = landmarks[28];

                // === 2. ç²å–é—œéµé» (å·¦æ‰‹ + å³æ‰‹) ç”¨æ–¼åˆ¤æ–·å¹³èˆ‰ ===
                // æˆ‘å€‘è¨ˆç®— "æ‰‹è‚˜-è‚©è†€-é«–éƒ¨" çš„è§’åº¦ï¼Œå¦‚æœè…‹ä¸‹æ‰“é–‹ç´„ 90 åº¦ï¼Œä»£è¡¨æ‰‹å¹³èˆ‰
                const leftShoulder = landmarks[11];
                const leftElbow = landmarks[13];
                // leftHip å·²ç¶“æœ‰äº†

                const rightShoulder = landmarks[12];
                const rightElbow = landmarks[14];
                // rightHip å·²ç¶“æœ‰äº†

                // æª¢æŸ¥ä¿¡å¿ƒåº¦ (ç¢ºä¿å…¨èº«å…¥é¡)
                const visibilityThreshold = 0.5;
                const isLegsVisible = leftHip.visibility > visibilityThreshold && leftKnee.visibility > visibilityThreshold && leftAnkle.visibility > visibilityThreshold &&
                                      rightHip.visibility > visibilityThreshold && rightKnee.visibility > visibilityThreshold && rightAnkle.visibility > visibilityThreshold;
                
                if (isLegsVisible) {
                    // --- A. è¨ˆç®—è…¿éƒ¨è§’åº¦ ---
                    const angleLeftLeg = calculateAngle(leftHip, leftKnee, leftAnkle);
                    const angleRightLeg = calculateAngle(rightHip, rightKnee, rightAnkle);
                    
                    // --- B. è¨ˆç®—è…‹ä¸‹è§’åº¦ (æ‰‹è‡‚æ˜¯å¦æŠ¬èµ·) ---
                    // é †åºï¼šæ‰‹è‚˜ - è‚©è†€ - é«–éƒ¨
                    const angleLeftArm = calculateAngle(leftElbow, leftShoulder, leftHip);
                    const angleRightArm = calculateAngle(rightElbow, rightShoulder, rightHip);

                    // ç¹ªè£½è…¿éƒ¨è§’åº¦æ•¸å€¼ (å¹³å‡å€¼æˆ–åˆ†é–‹é¡¯ç¤ºï¼Œé€™è£¡é¡¯ç¤ºå·¦è…¿ä»£è¡¨)
                    canvasCtx.fillStyle = 'white';
                    canvasCtx.font = '24px Arial';
                    canvasCtx.fillText(Math.round(angleLeftLeg), leftKnee.x * canvasElement.width + 10, leftKnee.y * canvasElement.height);
                    canvasCtx.fillText(Math.round(angleRightLeg), rightKnee.x * canvasElement.width - 40, rightKnee.y * canvasElement.height);

                    // === C. é‚è¼¯åˆ¤å®šæ ¸å¿ƒ ===
                    
                    // 1. åˆ¤æ–·æ‰‹æ˜¯å¦æ”¾ä¸‹ (è§’åº¦å¤ªå°ï¼Œä¾‹å¦‚å°æ–¼ 70åº¦)
                    // é€™é‚Šè¨­å®š 70 åº¦æ¯”è¼ƒå¯¬å®¹ï¼Œåªè¦ç¨å¾®èˆ‰èµ·ä¾†å°±ç®—
                    const isHandsUp = (angleLeftArm > 60) && (angleRightArm > 60);

                    if (!isHandsUp) {
                        // æ‰‹æ²’èˆ‰èµ·ä¾† -> é¡¯ç¤ºè­¦å‘Šï¼Œæš«åœè¨ˆæ•¸
                        warningMsg.style.display = "block"; 
                        // ç•«ç·šæ”¹ç‚ºç°è‰²ï¼Œè¡¨ç¤ºç„¡æ•ˆ
                        drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#999999', lineWidth: 2});
                    } else {
                        // æ‰‹æœ‰èˆ‰èµ·ä¾† -> éš±è—è­¦å‘Šï¼Œé–‹å§‹é‹ä½œ
                        warningMsg.style.display = "none";

                        // 2. æ·±è¹²é‚è¼¯ (é›™è…¿éƒ½è¦é”æ¨™)
                        // ç«™ç›´åˆ¤å®šï¼šé›™è…¿éƒ½è¦ > 160
                        if (angleLeftLeg > 160 && angleRightLeg > 160) {
                            stage = "UP";
                        }
                        
                        // è¹²ä½åˆ¤å®šï¼šé›™è…¿éƒ½è¦ < ç›®æ¨™è§’åº¦ ä¸” ç‹€æ…‹æ˜¯ UP
                        if (angleLeftLeg < targetAngle && angleRightLeg < targetAngle && stage === 'UP') {
                            stage = "DOWN";
                            count++;
                            repsDisplay.innerText = count;
                        }

                        stageDisplay.innerText = stage || "Stand";

                        // 3. è®Šè‰²åé¥‹ (é›™è…¿é”æ¨™è®Šç¶ ï¼Œå¦å‰‡ç´…)
                        let lineColor = '#FF0000'; // ç´…
                        let lineWidth = 4;

                        if (angleLeftLeg < targetAngle && angleRightLeg < targetAngle) {
                            lineColor = '#00FF00'; // ç¶ 
                            lineWidth = 8;
                        }

                        drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS,
                                     {color: lineColor, lineWidth: lineWidth});
                        drawLandmarks(canvasCtx, results.poseLandmarks,
                                    {color: lineColor, lineWidth: 2, radius: 4});
                    }
                }
            }
            canvasCtx.restore();
        }

        const pose = new Pose({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
        }});

        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        pose.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await pose.send({image: videoElement});
            },
            width: 640,
            height: 480
        });
        camera.start();
    </script>
</body>
</html>

