<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å°ˆæ¥­æ·±è¹²è¨ˆæ•¸ (å®Œæˆå‹•ä½œæ‰è¨ˆåˆ†)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #2c3e50;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            color: white;
        }

        h1 { margin-bottom: 10px; text-align: center; font-size: 24px;}

        .container {
            position: relative;
            width: 640px;
            height: 480px;
            background-color: #000;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        #input_video { display: none; }
        #output_canvas { width: 100%; height: 100%; }

        /* è¨ˆåˆ†æ¿ */
        .scoreboard {
            position: absolute;
            top: 0; left: 0;
            background-color: rgba(245, 117, 16, 0.9);
            padding: 10px 20px;
            border-bottom-right-radius: 15px;
            display: flex;
            gap: 20px;
            z-index: 10;
        }

        .score-item { display: flex; flex-direction: column; }
        .label { font-size: 12px; font-weight: bold; opacity: 0.9; }
        .value { font-size: 28px; font-weight: bold; }

        /* è­¦å‘Šè¨Šæ¯ */
        #warning-msg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 30px;
            border-radius: 15px;
            font-size: 28px;
            font-weight: bold;
            display: none;
            z-index: 20;
            text-align: center;
            line-height: 1.5;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* æ§åˆ¶é¢æ¿ */
        .controls {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            z-index: 10;
        }
        
        input[type=range] { width: 200px; cursor: pointer; }
        #angle-val { color: #f1c40f; font-size: 20px; font-weight: bold; min-width: 50px; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; }
    </style>
</head>
<body>

    <h1>ğŸ‹ï¸â€â™‚ï¸ å®Œæ•´å‹•ä½œæ‰è¨ˆåˆ†</h1>

    <div class="container">
        <div id="loading">è¼‰å…¥æ¨¡å‹ä¸­...</div>
        
        <div id="warning-msg">âš ï¸ è«‹å¼µé–‹é›™æ‰‹<br><span style="font-size:18px">(é›™æ‰‹é›¢é–‹èº«é«”å…©å´)</span></div>

        <div class="scoreboard">
            <div class="score-item">
                <span class="label">æ¬¡æ•¸ (REPS)</span>
                <span id="reps-display" class="value">0</span>
            </div>
            <div class="score-item">
                <span class="label">ç‹€æ…‹ (STAGE)</span>
                <span id="stage-display" class="value">-</span>
            </div>
        </div>

        <div class="controls">
            <span style="font-size:16px; font-weight:bold;">è…¿éƒ¨é›£åº¦:</span>
            <input type="range" id="angle-slider" min="80" max="150" value="90" step="5">
            <span id="angle-val">90Â°</span>
        </div>

        <video id="input_video"></video>
        <canvas id="output_canvas" width="640" height="480"></canvas>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const repsDisplay = document.getElementById('reps-display');
        const stageDisplay = document.getElementById('stage-display');
        const loadingMsg = document.getElementById('loading');
        const warningMsg = document.getElementById('warning-msg');
        
        const angleSlider = document.getElementById('angle-slider');
        const angleValDisplay = document.getElementById('angle-val');

        let count = 0;
        let stage = null; // UP æˆ– DOWN
        let targetAngle = 90;

        angleSlider.addEventListener('input', function() {
            targetAngle = this.value;
            angleValDisplay.innerText = this.value + "Â°";
        });

        function calculateAngle(a, b, c) {
            const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180.0) angle = 360 - angle;
            return angle;
        }

        function onResults(results) {
            loadingMsg.style.display = 'none';
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                const landmarks = results.poseLandmarks;

                const leftHip = landmarks[23];
                const leftKnee = landmarks[25];
                const leftAnkle = landmarks[27];
                const rightHip = landmarks[24];
                const rightKnee = landmarks[26];
                const rightAnkle = landmarks[28];
                const leftShoulder = landmarks[11];
                const leftElbow = landmarks[13];
                const rightShoulder = landmarks[12];
                const rightElbow = landmarks[14];

                const visibilityThreshold = 0.5;
                const isLegsVisible = leftHip.visibility > visibilityThreshold && leftKnee.visibility > visibilityThreshold && leftAnkle.visibility > visibilityThreshold &&
                                      rightHip.visibility > visibilityThreshold && rightKnee.visibility > visibilityThreshold && rightAnkle.visibility > visibilityThreshold;
                
                if (isLegsVisible) {
                    const angleLeftLeg = calculateAngle(leftHip, leftKnee, leftAnkle);
                    const angleRightLeg = calculateAngle(rightHip, rightKnee, rightAnkle);
                    const angleLeftArm = calculateAngle(leftElbow, leftShoulder, leftHip);
                    const angleRightArm = calculateAngle(rightElbow, rightShoulder, rightHip);

                    // é¡¯ç¤ºè…¿éƒ¨è§’åº¦
                    canvasCtx.fillStyle = 'white';
                    canvasCtx.font = '24px Arial';
                    canvasCtx.fillText(Math.round(angleLeftLeg), leftKnee.x * canvasElement.width + 10, leftKnee.y * canvasElement.height);
                    canvasCtx.fillText(Math.round(angleRightLeg), rightKnee.x * canvasElement.width - 40, rightKnee.y * canvasElement.height);

                    // æ‰‹è‡‚åˆ¤å®š (40åº¦å¯¬å®¹ç‰ˆ)
                    const armThreshold = 40; 
                    const isHandsUp = (angleLeftArm > armThreshold) && (angleRightArm > armThreshold);

                    if (!isHandsUp) {
                        warningMsg.style.display = "block"; 
                        drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#999999', lineWidth: 2});
                    } else {
                        warningMsg.style.display = "none";

                        // === ä¿®æ”¹å¾Œçš„è¨ˆæ•¸æ ¸å¿ƒé‚è¼¯ ===
                        
                        // 1. è¹²ä¸‹éšæ®µ (Going Down)
                        // ç•¶é›™è…³è§’åº¦å°æ–¼ç›®æ¨™å€¼æ™‚ï¼Œå°‡ç‹€æ…‹æ¨™è¨˜ç‚º "DOWN"
                        // é€™è£¡é‚„ä¸è¨ˆåˆ†ï¼Œåªæ˜¯è¨˜éŒ„ã€Œä½ å·²ç¶“è¹²ä¸‹å»äº†ã€
                        if (angleLeftLeg < targetAngle && angleRightLeg < targetAngle) {
                            if (stage === 'UP') {
                                stage = "DOWN";
                            }
                        }

                        // 2. ç«™èµ·éšæ®µ (Coming Up) - é€™æ˜¯åŠ åˆ†æ™‚åˆ»ï¼
                        // ç•¶é›™è…³è§’åº¦å¤§æ–¼ 160 (ç«™ç›´)ï¼Œä¸”ä¹‹å‰çš„ç‹€æ…‹æ˜¯ "DOWN"
                        if (angleLeftLeg > 160 && angleRightLeg > 160) {
                            if (stage === 'DOWN') {
                                count++;
                                repsDisplay.innerText = count;
                                stage = "UP"; // é‡ç½®ç‚ºç«™ç«‹ç‹€æ…‹ï¼Œæº–å‚™ä¸‹ä¸€æ¬¡
                            } else if (stage === null) {
                                // å‰›é–‹å§‹åµæ¸¬åˆ°ç«™ç«‹
                                stage = "UP";
                            }
                        }

                        stageDisplay.innerText = stage || "Stand";

                        // 3. è¦–è¦ºåé¥‹ (é¡è‰²)
                        // æ³¨æ„ï¼šé€™è£¡çš„é¡è‰²é‚è¼¯æ˜¯å³æ™‚çš„ï¼Œè®“ä½ è¹²ä¸‹å»æ™‚èƒ½çœ‹åˆ°ç¶ ç·šï¼ŒçŸ¥é“è‡ªå·±è¹²å¤ ä½äº†
                        let lineColor = '#FF0000'; 
                        let lineWidth = 4;

                        if (angleLeftLeg < targetAngle && angleRightLeg < targetAngle) {
                            lineColor = '#00FF00'; // è¹²å¤ ä½è®Šç¶ è‰²
                            lineWidth = 8;
                        }

                        drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS,
                                     {color: lineColor, lineWidth: lineWidth});
                        drawLandmarks(canvasCtx, results.poseLandmarks,
                                    {color: lineColor, lineWidth: 2, radius: 4});
                    }
                }
            }
            canvasCtx.restore();
        }

        const pose = new Pose({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
        }});

        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        pose.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await pose.send({image: videoElement});
            },
            width: 640,
            height: 480
        });
        camera.start();
    </script>
</body>
</html>
