<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ·±è¹²æ•™ç·´ (ç¶²é ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }

        h1 { margin-bottom: 10px; color: #333; }

        .container {
            position: relative;
            width: 640px;
            height: 480px;
            background-color: #000;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        /* éš±è—åŸå§‹ video å…ƒç´ ï¼Œæˆ‘å€‘åªçœ‹ canvas ç¹ªåœ–çµæœ */
        #input_video { display: none; }

        /* ç•«å¸ƒç–ŠåŠ  */
        #output_canvas {
            width: 100%;
            height: 100%;
        }

        /* å·¦ä¸Šè§’çš„è¨ˆåˆ†æ¿ */
        .scoreboard {
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(245, 117, 16, 0.8);
            padding: 15px 25px;
            border-bottom-right-radius: 15px;
            color: white;
            display: flex;
            gap: 30px;
        }

        .score-item {
            display: flex;
            flex-direction: column;
        }

        .label { font-size: 14px; font-weight: bold; }
        .value { font-size: 32px; font-weight: bold; }

        /* è¼‰å…¥ä¸­çš„é®ç½© */
        #loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            display: block;
        }
    </style>
</head>
<body>

    <h1>ğŸ‹ï¸â€â™‚ï¸ AI æ·±è¹²è¨ˆæ•¸å™¨</h1>

    <div class="container">
        <div id="loading">è¼‰å…¥æ¨¡å‹ä¸­ï¼Œè«‹ç¨å€™...</div>
        <div class="scoreboard">
            <div class="score-item">
                <span class="label">æ¬¡æ•¸ (REPS)</span>
                <span id="reps-display" class="value">0</span>
            </div>
            <div class="score-item">
                <span class="label">ç‹€æ…‹ (STAGE)</span>
                <span id="stage-display" class="value">-</span>
            </div>
        </div>

        <video id="input_video"></video>
        <canvas id="output_canvas" width="640" height="480"></canvas>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const repsDisplay = document.getElementById('reps-display');
        const stageDisplay = document.getElementById('stage-display');
        const loadingMsg = document.getElementById('loading');

        let count = 0;
        let stage = null;

        // --- æ•¸å­¸è¨ˆç®—å‡½æ•¸ (è·Ÿ Python ç‰ˆé‚è¼¯ä¸€æ¨£) ---
        function calculateAngle(a, b, c) {
            const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180.0) angle = 360 - angle;
            return angle;
        }

        // --- æ¯ä¸€å¹€çš„è™•ç†é‚è¼¯ ---
        function onResults(results) {
            // éš±è—è¼‰å…¥æ–‡å­—
            loadingMsg.style.display = 'none';

            // 1. ç¹ªè£½èƒŒæ™¯å½±åƒ
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                const landmarks = results.poseLandmarks;

                // 2. ç²å–é—œéµé» (å·¦åŠé‚Š)
                // MediaPipe JS çš„é»æ˜¯ 0~1 çš„æ¯”ä¾‹ï¼Œä¸éœ€è¦åƒ Python é‚£æ¨£ .value å–å€¼
                const hip = landmarks[23];  // LEFT_HIP
                const knee = landmarks[25]; // LEFT_KNEE
                const ankle = landmarks[27]; // LEFT_ANKLE
                
                // æª¢æŸ¥ä¿¡å¿ƒåº¦ (é˜²æ­¢èª¤åˆ¤)
                if (hip.visibility > 0.5 && knee.visibility > 0.5 && ankle.visibility > 0.5) {
                    
                    // è¨ˆç®—è§’åº¦
                    const angle = calculateAngle(hip, knee, ankle);

                    // ç¹ªè£½è§’åº¦æ•¸å­—
                    canvasCtx.fillStyle = 'white';
                    canvasCtx.font = '24px Arial';
                    canvasCtx.fillText(Math.round(angle), knee.x * canvasElement.width, knee.y * canvasElement.height);

                    // --- æ·±è¹²é‚è¼¯ ---
                    if (angle > 160) {
                        stage = "UP";
                    }
                    if (angle < 90 && stage === 'UP') {
                        stage = "DOWN";
                        count++;
                        repsDisplay.innerText = count;
                    }
                    stageDisplay.innerText = stage || "Stand";

                    // --- è®Šè‰²é‚è¼¯ ---
                    let lineColor = '#00FF00'; // é è¨­ç¶ è‰² (MediaPipe é è¨­)
                    let lineWidth = 4;
                    
                    if (angle < 90) {
                        // è¹²ä½æ™‚è®Šäº®ç¶ è‰²ä¸”åŠ ç²—
                        lineColor = '#00FF00';
                        lineWidth = 8;
                    } else {
                        // å¹³å¸¸é¡¯ç¤ºç´…è‰²
                        lineColor = '#FF0000';
                    }

                    // 3. ç¹ªè£½éª¨æ¶
                    drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS,
                                 {color: lineColor, lineWidth: lineWidth});
                    drawLandmarks(canvasCtx, results.poseLandmarks,
                                {color: lineColor, lineWidth: 2, radius: 4});
                }
            }
            canvasCtx.restore();
        }

        // --- åˆå§‹åŒ– MediaPipe Pose ---
        const pose = new Pose({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
        }});

        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        pose.onResults(onResults);

        // --- å•Ÿå‹•æ”å½±æ©Ÿ ---
        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await pose.send({image: videoElement});
            },
            width: 640,
            height: 480
        });
        camera.start();
    </script>
</body>
</html>